---
title: "Taller 3: Herramientas Estadísticas"
author: "Modelos de Series de Tiempo I"
date: "Diplomado en Data Science UC - Facultad de Matemáticas UC "
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Casos Covid en la Región de Magallanes

En el archivo *Casos_diarios_Magallanes.csv* se encuentran los casos diarios registrados mediante examen PCR desde mediados de Febrero hasta finales de Mayo del presente año en la Región de Magallanes, además encontrará la evolución diaria de vacunados en el archivo *Vacunacion_Magallanes.csv* con el detalle de vacunación de la Primera, Segunda y Única dosis en la Región de Magallanes. Se busca comprender la evolución de casos diarios de modo de predecir el comportamiento esperado en el mes de Junio.


Librerías de utilidad:

```{r, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(forecast)
library(ggplot2)
library(tseries)
library(lmtest)
```


#### a) Importe las bases de datos y realice el cruce correspondiente de modo de tener por día la información de los casos diarios y el detalle de vacunación.

```{r, message=FALSE}

casos <- read_csv("Casos_diarios_Magallanes.csv")
vacunacion <- read_csv("Vacunacion_Magallanes.csv")


data<-casos%>%
      left_join(., vacunacion, by="Fecha")

head(data)

```

#### b) Defina los casos diarios en la región de Magallanes en formato de serie de tiempo y realice un gráfico para visualizar la serie. ¿Cómo se observa la evolución de casos en el período? Comente.

```{r}
casos_ts <- ts(data$Casos_Magallanes, 
               start = min(data$Fecha), 
               frequency = 365)

#Opción 1 (No muestra detalle de fechas)
autoplot(casos_ts) +
  ggplot2::theme_light()

#Opción 2: (Muestra más detalle)
ggplot() +
  aes(x = data$Fecha, y = data$Casos_Magallanes) +
  geom_line(lwd = 0.8) +
  xlab("Fecha")+
  ylab("Casos Diarios")+
  ggtitle("Casos diarios en la Región de Magallanes")+
  theme_light()+
  theme(title = element_text(size=16, hjust=0.5))
```

#### c) En base al gráfico anterior, comente si la serie es estacionaria o no. Aplique diferenciación de ser necesaria y grafique nuevamente. ¿Es estacionaria?


En el gráfico anterior no se observa una media constante en el tiempo, por lo tanto no sería una serie estacionaria, es necesario aplicar diferenciación:

```{r}
autoplot(diff(casos_ts))
```

La media se observa constante pero la varianza varía en algunos momentos, quizás sea necesaria una transformación.


#### d) Evalúe si es necesaria una transformación de Boxcox para la serie de tiempo.

```{r}

(lambda <- BoxCox.lambda(casos_ts))

```

El valor obtenido para lambda es 1, por lo tanto, no se necesitaría una transformación de Boxcox.

#### e) Evalúe la estacionaridad de la serie utilizando el test de Dickey-Fuller en la serie diferenciada (Concluya con un 95% de confianza).


Recordar que el test de Dickey-Fuller es:

$H_{0}$: La serie de tiempo tiene una raíz unitaria (no es estacionaria)

$H_{1}$: La serie de tiempo NO tiene una raíz unitaria.


```{r}
adf.test(diff(casos_ts))
```
El valor-p obtenido es menor que el 5%, por ende, se rechaza la hipótesis nula de no estacionariedad, por lo tanto, la serie es estacionaria.

#### f) Estudie el ACF y PACF de la serie para estudiar sus componentes AR y MA. Comente.

```{r}
acf(diff(casos_ts), lag.max=60)
```
```{r}
pacf(diff(casos_ts), lag.max=60)
```



#### g) Utilice la función _auto.arima()_ para obtener una propuesta de modelo para los datos. Evalúe la significancia de las componentes y visualice el modelo en los datos. 


```{r}

modelo <- auto.arima(casos_ts)

coeftest(modelo)

autoplot(casos_ts) +
  geom_line(aes(y = modelo$fitted), color = "darkcyan") +
  theme_light() 

```

El modelo sigue la tendencia de la serie, pero le cuesta alcanzar valores más altos o más bajos, está más acotado.

#### h) Realice un diagnóstico de los residuos:


##### h.1) Realice el test de Ljung-Box para revisar el supuesto de que los datos se distribuyen de forma indepeniente, utilice un 95% de confianza para concluir.

Recuerde que el test de Ljung-Box testea las siguientes hipótesis:

$H_{0}$:Los datos se distribuyen de forma independiente 
$H_{1}$: Los datos no se distribuyen de forma independiente


```{r}
checkresiduals(modelo)
```

El valor-p es 0.059, el cual es mayor que el 5% de significancia pero notar que se encuentra bastante en el borde, es decir, estaría al borde de cumplir que los datos se distribuyen de forma independiente.


#### h.2) Realice el test de Shapiro para testear la normalidad de los residuos, utilice un 95% de confianza para concluir.

Recuerde que el test de Shapiro testea las siguientes hipótesis:

$H_{0}$:Los datos se distribuyen de forma independiente 
$H_{1}$: Los datos no se distribuyen de forma independiente

```{r}
shapiro.test(modelo$residuals)
```

Dado el valor-p de 0.1 es mayor que el 5% no se rechaza el supuesto de normalidad de los residuos.

#### i) Utilizando el modelo anterior, realice una predicción de los casos diarios en el mes de Junio. ¿Qué predice el modelo? Comente. 

```{r}
pred <- forecast(modelo, h = 30) # Realizamos una predicción a 10 días
autoplot(pred)
```
#### j) Obtenga un modelo arima utilizando como regresor la cantidad de personas vacunadas (Primeras dosis + vacunas únicas). Obtenga la predicción de casos en Junio, ¿cómo se comporta la predicción? Comente.


```{r}

data<-data%>%
  mutate(vacunados=Primera_Dosis+Unica_Dosis)

model_r<- auto.arima(casos_ts, xreg=data$vacunados)


pred_r <- forecast(model_r, h = 30, xreg=data$vacunados) # Realizamos una predicción a 10 días
autoplot(pred_r)
```
```{r}
### CON DATOS DE VACUNACION DEL PERIODO


Vacunacion_predict <- read_csv("Vacunacion_Magallanes_predict.csv")

Vacunacion_predict<-Vacunacion_predict%>%
  mutate(vacunados=Primera_Dosis+Unica_Dosis)

pred_r2 <- forecast(model_r, h = 30, xreg=Vacunacion_predict$vacunados) # Realizamos una predicción a 10 días
autoplot(pred_r2)

```


#### k) ¿Cómo cree que se pudiera evaluar la capacidad predictiva de modelos de series de tiempo?


Para evaluar la capacidad predictiva de un modelo de serie de tiempo, se pueden utilizar los datos reales del período, por ejemplo de Junio y ver cómo se comporta la predicción y calcular el error asociado, lo importante es que no se deben tomar datos aislados (registros aleatorios), sino que fragmentos temporales (días continuos).


